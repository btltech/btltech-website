<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>BTLTech Ltd · Invoice PRO Light · Stable</title>
  <meta name="color-scheme" content="light only">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <style>
    :root{
      --bg:#f3f6fb; --panel:#ffffff; --panel-2:#f8fafc; --text:#0f172a; --muted:#475569;
      --line:#e2e8f0; --primary:#2563eb; --ok:#10b981; --danger:#ef4444;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif}
    body{margin:0;background:var(--bg);color:var(--text)}
    .wrap{max-width:800px;margin:5px auto;padding:0 8px}
    .page{background:#fff;width:210mm;min-height:297mm;margin:0 auto;padding:8mm;position:relative;box-sizing:border-box}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:8px;padding:12px;box-shadow:0 4px 16px rgba(0,0,0,.06)}
    .top{display:flex;align-items:center;justify-content:center;margin-bottom:8px;gap:8px}
    .brand{display:flex;gap:12px;align-items:center;justify-content:center;flex-direction:column;min-width:0;text-align:center;width:100%}
    #logoPreview{height:120px;max-width:400px;object-fit:contain;display:block}
    .muted{color:var(--muted);font-size:13px}
    label{display:block;margin:4px 0 2px;font-size:11px;color:#334155}
    input,select,textarea{width:100%;padding:6px;border-radius:6px;border:1px solid var(--line);background:var(--panel-2);color:var(--text);font-size:12px}
    textarea{min-height:60px;resize:vertical}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:6px}
    .grid-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:6px}
    .row{display:grid;grid-template-columns:2fr 70px 90px 90px auto;gap:4px;align-items:center;margin-top:4px}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:6px 10px;border-radius:8px;border:1px solid var(--line);background:#eef2ff;color:var(--text);cursor:pointer;font-weight:600;font-size:12px}
    .btn-primary{background:var(--primary);border-color:transparent;color:#fff}
    .btn-ok{background:var(--ok);border-color:transparent;color:#062315}
    .btn-danger{background:#fee2e2;border-color:#fecaca;color:#991b1b}
    .btn-ghost{background:#f1f5f9}
    .toolbar{display:flex;gap:6px;flex-wrap:wrap}
    .totals{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-top:8px}
    .box{background:var(--panel-2);border:1px solid var(--line);border-radius:6px;padding:8px}
    .box h4{margin:0 0 4px 0;font-size:12px}
    hr{border:none;border-top:1px solid var(--line);margin:8px 0}
    .note{font-size:11px;color:var(--muted)}
    .watermark{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%) rotate(-45deg);opacity:0.15;z-index:1;pointer-events:none;max-width:300px;max-height:300px;}
    .paid-stamp{position:absolute; top:12px; right:12px; color:#15803d; border:2px solid #15803d; padding:6px 10px; border-radius:6px; font-weight:800; font-size:18px; transform:rotate(-10deg); background:rgba(240,253,244,.95); z-index:2; display:none;}
    .is-paid .paid-stamp{display:block;}
    .visually-hidden{position:absolute !important; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0;}
    /* Compact receipt (A5) */
    .receipt{background:#fff;color:#0f172a;padding:8mm;width:100%;box-sizing:border-box}
    .receipt-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .receipt-title{font-weight:800;font-size:16px}
    .receipt-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:8px}
    .receipt-table{width:100%;border-collapse:collapse;font-size:11px}
    .receipt-table th,.receipt-table td{border-bottom:1px solid var(--line);padding:6px;text-align:left}
    .text-right{text-align:right}
    .receipt-paid{color:#15803d;border:2px solid #15803d;padding:4px 8px;border-radius:6px;font-weight:800;transform:rotate(-6deg)}
    .receipt-small{font-size:11px;color:#64748b}
    .sticky-totals{position:fixed;bottom:0;left:0;right:0;background:var(--panel);border-top:2px solid var(--primary);padding:16px;box-shadow:0 -4px 20px rgba(0,0,0,0.1);z-index:100;}
    .sticky-totals .wrap{max-width:800px;margin:0 auto;padding:0 8px;}
    .sticky-totals .totals{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin:0;}
    .sticky-totals .box{background:var(--panel-2);border:1px solid var(--line);border-radius:6px;padding:8px;text-align:center;}
    .sticky-totals .box h4{margin:0 0 4px 0;font-size:12px;color:var(--muted);}
    .sticky-totals .box div{font-size:16px;font-weight:700;color:var(--text);}
    .body-with-sticky{padding-bottom:100px;}
    .error{color:var(--danger);font-size:12px;margin-top:4px;}
    .error input{border-color:var(--danger);}
    .shake{animation:shake 0.5s ease-in-out;}
    @keyframes shake{0%,100%{transform:translateX(0);}25%{transform:translateX(-5px);}75%{transform:translateX(5px);}}
    .toast{position:fixed;top:20px;right:20px;background:var(--ok);color:white;padding:12px 16px;border-radius:8px;z-index:1000;animation:slideIn 0.3s ease-out;}
    @keyframes slideIn{from{transform:translateX(100%);opacity:0;}to{transform:translateX(0);opacity:1;}}
    .copy-icon{cursor:pointer;margin-left:8px;opacity:0.6;transition:opacity 0.2s;}
    .copy-icon:hover{opacity:1;}
    .primary-add{width:100%;margin-top:6px;padding:8px;font-size:13px;font-weight:700;}
    .customer-search{position:relative;}
    .customer-dropdown{position:absolute;top:100%;left:0;right:0;background:var(--panel);border:1px solid var(--line);border-radius:6px;max-height:150px;overflow-y:auto;z-index:50;display:none;}
    .customer-option{padding:12px;cursor:pointer;border-bottom:1px solid var(--line);}
    .customer-option:hover{background:var(--panel-2);}
    .customer-option:last-child{border-bottom:none;}
    .model-search{position:relative;}
    .model-dropdown{position:absolute;top:100%;left:0;right:0;background:var(--panel);border:1px solid var(--line);border-radius:8px;max-height:150px;overflow-y:auto;z-index:50;display:none;}
    .model-option{padding:8px 12px;cursor:pointer;border-bottom:1px solid var(--line);}
    .model-option:hover{background:var(--panel-2);}
    .model-option:last-child{border-bottom:none;}
    .icon-btn{background:none;border:none;cursor:pointer;padding:4px;border-radius:4px;color:var(--danger);}
    .icon-btn:hover{background:var(--danger);color:white;}
    .discount-row{display:grid;grid-template-columns:2fr 80px 100px 100px 100px auto;gap:6px;align-items:center;margin-top:6px;}
    .print-only-section{text-align:center; margin-bottom:20px; padding:16px; border:2px solid #e2e8f0; border-radius:8px;}
    .print-only-section-main{font-size:14px; color:#64748b; margin-bottom:8px;}
    .print-only-section-sub{font-size:12px; color:#64748b;}
    .brand-logo{height:100px; width:auto; object-fit:contain;}
    .brand-payment-details{font-size:10px; margin-top:1px;}
    .vat-controls-container{margin-top:8px; padding:10px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px;}
    .vat-controls-flex{display:flex; align-items:center; gap:12px; flex-wrap:wrap;}
    .vat-label{display:flex; align-items:center; gap:8px; margin:0; cursor:pointer;}
    .vat-checkbox{width:18px; height:18px; margin:0;}
    .vat-label-text{font-weight:600; color:#334155;}
    .vat-rate-container{display:flex; align-items:center; gap:8px;}
    .vat-rate-select{width:100px; padding:8px; border:1px solid #d1d5db; border-radius:8px;}
    #vatWarning{display:none; margin-top:8px;}
    .discount-desc{grid-column:1;}
    .discount-amount{grid-column:5;}
    .apply-discount-btn{grid-column:6;}
    .banking-details{background:#f8fafc; padding:8px; border-radius:6px; border-left:3px solid #2563eb; margin-top:10px;}
    .undo-btn{margin-left:8px; background:white; color:#10b981; border:none; padding:4px 8px; border-radius:4px; cursor:pointer;}
    .discount-item{color:#ef4444; font-style:italic;}
    .tooltip{position:relative;}
    .tooltip::after{content:attr(data-tooltip);position:absolute;bottom:100%;left:50%;transform:translateX(-50%);background:#333;color:white;padding:8px;border-radius:4px;font-size:12px;white-space:nowrap;opacity:0;pointer-events:none;transition:opacity 0.2s;z-index:1000;}
    .tooltip:hover::after{opacity:1;}
    .locked{background:#f1f5f9;color:#64748b;cursor:not-allowed;}
    .warning{background:#fef3c7;border:1px solid #f59e0b;color:#92400e;padding:8px 12px;border-radius:8px;margin:8px 0;font-size:13px;}
    .print-only{display:none;}
    .no-print{display:block;}
    /* Ledger modal */
    .modal-overlay{position:fixed;inset:0;background:rgba(15,23,42,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;}
    .modal{background:#fff;border:1px solid var(--line);border-radius:8px;box-shadow:0 10px 30px rgba(0,0,0,.2);max-width:920px;width:95%;padding:12px;}
    .modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .modal-controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
    .modal-body{max-height:60vh;overflow:auto;border:1px solid var(--line);border-radius:6px}
    table{width:100%;border-collapse:collapse;font-size:12px}
    th,td{border-bottom:1px solid var(--line);padding:8px;text-align:left}
    th{background:#f8fafc;position:sticky;top:0;z-index:1}
    .totals-inline{display:grid;grid-template-columns:repeat(5,1fr);gap:6px;margin-bottom:8px}
    /* PDF export alignment */
    .pdf-export .page{width:210mm;margin:0 auto;min-height:297mm;display:block}
    
    /* Mobile Responsive Design */
    @media screen and (max-width: 768px) {
      .wrap { max-width: 100%; margin: 0; padding: 4px; }
      .page { 
        width: 100%; 
        min-height: auto; 
        margin: 0; 
        padding: 8px; 
        box-shadow: none;
        border-radius: 0;
      }
      
      /* Mobile header */
      .top { margin-bottom: 12px; }
      .brand { flex-direction: column; align-items: center; text-align: center; }
      .brand-title { font-size: 18px; margin-bottom: 4px; }
      .brand img, #logoPreview { height: 40px !important; }
      
      /* Mobile form elements */
      input, select, textarea { 
        font-size: 16px; /* Prevent zoom on iOS */
        padding: 8px; 
        margin: 2px 0; 
        width: 100%;
        max-width: 100%;
      }
      label { font-size: 12px; margin: 4px 0 2px; }
      
      /* Mobile grid layouts */
      .grid-2 { grid-template-columns: 1fr; gap: 8px; }
      .grid-3 { grid-template-columns: 1fr; gap: 8px; }
      .row { 
        grid-template-columns: 1fr; 
        gap: 4px; 
        margin-top: 6px;
        font-size: 12px;
      }
      .discount-row { 
        grid-template-columns: 1fr; 
        gap: 4px; 
        margin-top: 6px;
        font-size: 12px;
      }
      
      /* Mobile tables */
      .table-responsive {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
      }
      table { min-width: 500px; font-size: 12px; }
      th, td { padding: 4px 2px; }
      
      /* Mobile buttons */
      .toolbar { 
        display: flex; 
        flex-wrap: wrap; 
        gap: 8px; 
        margin-bottom: 12px;
        padding: 8px;
        background: var(--panel-2);
        border-radius: 6px;
      }
      .btn { 
        flex: 1; 
        min-width: 120px; 
        padding: 10px 8px; 
        font-size: 14px; 
        border-radius: 6px;
        touch-action: manipulation;
      }
      
      /* Mobile boxes */
      .box { 
        padding: 8px; 
        margin: 6px 0; 
        border-radius: 6px;
      }
      .box h4 { font-size: 14px; margin: 0 0 6px 0; }
      
      /* Mobile totals */
      .totals { 
        gap: 6px; 
        margin-top: 12px; 
        padding: 8px;
        font-size: 14px;
      }
      .sticky-totals {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: var(--panel);
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        padding: 8px;
        z-index: 1000;
      }
      .body-with-sticky { padding-bottom: 80px; }
      
      /* Mobile banking details */
      .banking-details { 
        margin-top: 12px; 
        padding: 8px; 
        font-size: 12px;
      }
      
      /* Mobile mark paid section */
      .mark-paid-section {
        margin: 8px 0;
        padding: 8px;
        text-align: center;
      }
      
      /* Hide elements on small screens */
      .copy-icon { display: none; }
      
      /* Mobile dropdown improvements */
      .dropdown {
        position: relative;
        z-index: 100;
      }
      .dropdown-content {
        position: absolute;
        max-height: 200px;
        overflow-y: auto;
        width: 100%;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      }
      
      /* Touch-friendly interactions */
      button, .btn, select, input[type="checkbox"] {
        min-height: 44px;
        min-width: 44px;
      }
      
      /* Mobile specific hide/show */
      .mobile-hide { display: none !important; }
      .mobile-show { display: block !important; }
    }
    
    @media screen and (max-width: 480px) {
      .wrap { padding: 2px; }
      .page { padding: 6px; }
      .brand-title { font-size: 16px; }
      .btn { min-width: 100px; font-size: 12px; padding: 8px 6px; }
      table { font-size: 11px; }
      .totals { font-size: 12px; }
      input, select, textarea { font-size: 16px; padding: 6px; }
    }
    
    @media print{
      @page { size: A4; margin: 8mm; }
      html,body{ height:auto; margin:0; padding:0; }
      body{ background:white; -webkit-print-color-adjust: exact; print-color-adjust: exact; font-size:9px; line-height:1.2; }
      .wrap{ margin:0; width:100%; padding:0; max-width:none; }
      .card{ border:none; box-shadow:none; padding:4mm; width:100%; height:auto; display:block; }
      .page{ min-height:auto !important; width:100%; margin:0; padding:0; height:auto; max-height:none; overflow:visible; }
      
      /* Compact header */
      .top{ margin-bottom:3mm; }
      #logoPreview, .brand-logo{ height:35px !important; }
      .brand{ margin-bottom:3mm; }
      
      /* Compact form elements */
      input,select,textarea{ padding:2px; font-size:8px; border:1px solid #999; margin:1px 0; }
      label{ margin:1px 0; font-size:8px; }
      
      /* Tight grid layouts */
      .row{ grid-template-columns:2.5fr 40px 60px 60px auto; gap:1px; margin-top:1px; font-size:8px; }
      .grid-2{ gap:2mm; margin-bottom:2mm; }
      .grid-3{ gap:2mm; margin-bottom:2mm; }
      .discount-row{ grid-template-columns:2.5fr 40px 60px 60px 60px auto; gap:1px; margin-top:1px; font-size:8px; }
      
      /* Compact content boxes */
      .box{ padding:2px; margin:1px 0; font-size:8px; break-inside: avoid; }
      .box h4{ font-size:9px; margin:0 0 1px 0; }
      .totals{ gap:2px; margin-top:3mm; break-inside: avoid; }
      .note{ font-size:7px; margin:1px 0; line-height:1.1; }
      .banking-details{ margin-top:3mm; padding:2px; break-inside: avoid; font-size:7px; display:block !important; }
      
      /* Hide ALL interactive elements */
      .toolbar, .no-print, #add, .primary-add, .btn, button, .copy-icon{ display:none !important; }
      .sticky-totals{ display:none !important; }
      .body-with-sticky{ padding-bottom:0 !important; }
      .modal-overlay{ display:none !important; }
      .mark-paid-section{ display:none !important; }
      
      /* Show essential elements */
      .watermark{ display:block !important; opacity:0.06; }
      .is-paid .paid-stamp{ display:block !important; }
      
      /* Force page fit */
      .row, .box, .totals, .grid-2, .grid-3, .banking-details{ break-inside: avoid; page-break-inside: avoid; }
      hr{ margin:2px 0; page-break-before: avoid; page-break-after: avoid; }
      
      /* Ensure content fits */
      .totals.no-print{ display:grid !important; }
      .login-screen{ display:none !important; }
      
      /* Scale down if needed */
      .page{ transform:scale(0.95); transform-origin:top left; }
    }
    
    /* Login screen styles */
    .login-screen{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(135deg, rgba(15,23,42,.85), rgba(15,23,42,.75));z-index:2000;padding:16px}
    .login-card{background:#fff;border:1px solid var(--line);border-radius:12px;box-shadow:0 12px 30px rgba(0,0,0,.25);width:100%;max-width:360px;padding:20px;text-align:center}
    .login-logo{height:72px;width:auto;object-fit:contain;margin-bottom:12px}
    .login-card h2{margin:0 0 8px 0;font-size:18px;color:#0f172a}
    .login-card p{margin:0 0 12px 0;color:#64748b;font-size:12px}
    .login-card input{width:100%;padding:10px;border:1px solid #d1d5db;border-radius:8px;font-size:16px;margin:8px 0}
    .login-card button{width:100%;padding:10px;border:none;border-radius:8px;background:#2563eb;color:#fff;font-weight:700;cursor:pointer}
    .login-card button:hover{background:#1e4ed8}
    .login-error{display:none;color:#ef4444;font-size:12px;margin-top:8px}
  </style>
</head>
<body>
  <div id="loginScreen" class="login-screen">
    <div class="login-card">
      <img src="logo.jpeg" alt="BTLTech logo" class="login-logo" />
      <h2>Enter Access Code</h2>
      <p>Authorised use only</p>
      <input id="loginPassword" type="password" placeholder="Password" autocomplete="current-password" />
      <button id="loginSubmit">Enter</button>
      <div id="loginError" class="login-error">Incorrect password</div>
    </div>
  </div>
  <div class="wrap body-with-sticky">
    <div class="page">
    <div class="card">
        <img class="watermark" src="logo.jpeg" alt="BTLTech watermark" style="display:none;">
        
        
        
      <div class="top">
        <div class="brand">
            <img id="logoPreview" alt="BTLTech logo" src="logo.jpeg" class="brand-logo" />
          <div>
              <div class="brand-title">BTLTech Ltd Invoice</div>
              <div class="muted">info@btltech.co.uk 02087460193 07445363599</div>
          </div>
        </div>
      </div>

      <div class="grid-3">
          <div><label for="invNo">Invoice No</label><input id="invNo" readonly><span class="copy-icon" id="copyInvNo" title="Copy invoice number">📋</span></div>
          <div><label for="invDate">Date</label><input id="invDate" type="date"></div>
          <div><label for="dueDate">Due</label><input id="dueDate" type="date"></div>
      </div>

      <div class="grid-2">
          <div class="customer-search">
            <label for="clientName">Customer</label>
            <input id="clientName" placeholder="Search or type new customer name">
            <div id="customerDropdown" class="customer-dropdown"></div>
          </div>
          <div><label for="clientContact">Phone/Email</label><input id="clientContact" type="email"></div>
      </div>

      <div class="grid-3">
          <div><label for="devType">Device type</label><select id="devType"></select></div>
          <div><label for="devMake">Device make</label><select id="devMake"></select></div>
          <div class="model-search">
            <label for="devModel">Device model</label>
            <input id="devModel" placeholder="Type to search models" autocomplete="off">
            <div id="modelDropdown" class="model-dropdown"></div>
          </div>
      </div>

      <div class="grid-2">
        <div><label for="devSerial">Serial / IMEI</label><input id="devSerial" placeholder="Device serial or IMEI number"></div>
        <div><label for="devCondition">Cosmetic Condition</label><input id="devCondition" placeholder="e.g., Scratched back, screen mint"></div>
      </div>

      <div>
        <label for="reportedFault">Reported Fault</label>
        <textarea id="reportedFault" placeholder="Describe the issue reported by the customer"></textarea>
      </div>

      <div>
        <label for="devAccessories">Accessories Left (charger, case, etc.)</label>
        <input id="devAccessories" placeholder="List any accessories left with device">
      </div>

        <label for="remark">Remarks</label>
        <textarea id="remark" placeholder="Optional notes / comments"></textarea>

      <div class="grid-2">
          <div><label for="device">Device (auto-filled)</label><input id="device"></div>
          <div><label for="service">Service</label><select id="service"></select></div>
      </div>

        <label for="desc">Description</label><input id="desc" placeholder="Part or service (auto-filled from service)">

      <div class="row">
          <input id="qty" type="number" min="1" value="1" aria-label="Quantity" />
          <input id="price" type="number" min="0" step="0.01" value="0" aria-label="Unit price" />
          <input id="line" disabled value="£0.00" aria-label="Line total" />
        <button class="btn btn-danger" id="clear">Clear</button>
      </div>

        <button class="btn btn-primary primary-add" id="add">+ Add Item</button>

        <div class="table-responsive">
      <div id="list"></div>
        </div>

        <div class="box vat-controls-container" id="vatControls">
          <div class="vat-controls-flex">
            <label class="vat-label">
              <input type="checkbox" id="vatEnabled" class="vat-checkbox">
              <span class="vat-label-text">Charge VAT</span>
            </label>
            <div class="vat-rate-container">
              <select id="vatRate" class="vat-rate-select" aria-label="VAT Rate">
                <option value="0">0%</option>
                <option value="5">5%</option>
                <option value="20" selected>20%</option>
              </select>
            </div>
          </div>
          <div id="vatWarning" class="warning">
            ⚠️ Warning: VAT is disabled but customer may be VAT-registered. Check compliance requirements.
          </div>
        </div>

      <div class="totals">
        <div class="box"><h4>Subtotal</h4><div id="subtotal">£0.00</div></div>
          <div class="box"><h4>VAT</h4><div id="vatAmount">£0.00</div></div>
        <div class="box"><h4>Total</h4><div id="grand">£0.00</div></div>
      </div>

        <div class="grid-2">
          <div><label for="jobStatus">Status</label><select id="jobStatus" aria-label="Job status">
              <option value="received">Received</option>
              <option value="progress">In progress</option>
              <option value="completed">Completed</option>
              <option value="collected">Collected</option>
            </select></div>
          <div></div>
        </div>
        
        <div class="discount-row">
          <input id="discountDesc" placeholder="Discount description (optional)" class="discount-desc">
          <input id="discountAmount" type="number" min="0" step="0.01" value="0" placeholder="0.00" class="discount-amount">
          <button class="btn btn-ghost apply-discount-btn" id="applyDiscount">Apply</button>
        </div>

      <div class="grid-2">
        <div>
          <label for="staffName">Staff Name</label>
          <input id="staffName" placeholder="Your name (or initials)">
        </div>
        <div>
          <label for="staffInitials">Staff Initials</label>
          <input id="staffInitials" placeholder="Initials (optional)">
        </div>
      </div>
        <hr>

        <div class="toolbar no-print">
          <button class="btn btn-primary" id="print">Download PDF</button>
          <button class="btn btn-ghost" id="generatePDF">Print Preview</button>
          <button class="btn btn-ok" id="receipt">Receipt</button>
          <button class="btn btn-ghost" id="bookkeeping">Bookkeeping</button>
      </div>

        <div class="mark-paid-section no-print" style="margin: 15px 0; padding: 10px; border: 1px solid #e0e0e0; border-radius: 8px; background: #f9f9f9;">
          <label class="vat-label">
            <input type="checkbox" id="markPaid" class="vat-checkbox">
            <span class="vat-label-text">Mark as Paid</span>
          </label>
      </div>

        
        <div class="note">Payment due immediately. Goods remain property of BTLTech Ltd until paid in full. 30-day warranty excludes accidental, liquid, or physical damage. Data recovery is not guaranteed.</div>
        <div class="note"><strong>Uncollected Goods Policy:</strong> Devices not collected within 60 days of completion may be sold or recycled to recover costs.</div>
        <div class="note banking-details">
          <strong>Banking Details:</strong><br>
          Bank: Starling Bank<br>
          Sort Code: 60-83-71<br>
          Account Number: 56169159<br>
          Account Name: BTLTech Ltd
        </div>
        <div id="paidStamp" class="paid-stamp" style="display:none;">PAID</div>
      </div>
    </div>
  </div>

  <!-- Sticky Totals Bar -->
  <div class="sticky-totals no-print">
    <div class="wrap">
      <div class="totals">
        <div class="box"><h4>Subtotal</h4><div id="stickySubtotal">£0.00</div></div>
        <div class="box"><h4>VAT</h4><div id="stickyVat">£0.00</div></div>
        <div class="box"><h4>Total</h4><div id="stickyTotal">£0.00</div></div>
      </div>
    </div>
  </div>

  <!-- Bookkeeping Modal -->
  <div id="ledgerOverlay" class="modal-overlay no-print" style="display:none;">
    <div class="modal">
      <div class="modal-header">
        <div style="font-weight:700">Bookkeeping</div>
        <button id="closeLedger" class="icon-btn" title="Close">✕</button>
      </div>
      <div class="modal-controls">
        <label>From <input type="date" id="ledgerStart"></label>
        <label>To <input type="date" id="ledgerEnd"></label>
        <label>Paid 
          <select id="filterPaid">
            <option value="all">All</option>
            <option value="paid">Paid</option>
            <option value="unpaid">Unpaid</option>
          </select>
        </label>
        <label>Customer <input type="text" id="filterCustomer" placeholder="Search customer"></label>
        <label>Device <input type="text" id="filterDevice" placeholder="Type/make/model"></label>
        <button class="btn btn-ghost" id="exportCsv">Export CSV</button>
        <button class="btn btn-ghost" id="exportJson">Backup JSON</button>
        <button class="btn btn-ghost" id="importJsonBtn">Restore JSON</button>
        <input type="file" id="importJson" accept="application/json" style="display:none" />
        <button class="btn btn-danger" id="resetData">Reset Data</button>
      </div>
      <div id="ledgerTotals" class="totals-inline"></div>
      <div id="ledgerKpis" class="box" style="margin-top:8px"></div>
      <div id="ledgerCharts" class="box" style="margin-top:8px"></div>
      <div class="modal-body">
        <div class="table-responsive">
          <table>
            <thead>
            <tr>
              <th>Date</th>
              <th>Invoice</th>
              <th>Customer</th>
              <th>Sales</th>
              <th>Service</th>
              <th>Discounts</th>
              <th>VAT</th>
              <th>Total</th>
              <th>Actions</th>
            </tr>
            </thead>
            <tbody id="ledgerTable"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script>
"use strict";

// Auth (password gate)
const ACCESS_CODE = 'BTL2024';

function rebindMainListeners(){
  // Ensure all main button listeners are working
  try{
    var addBtn=document.getElementById('add');
    var clearBtn=document.getElementById('clear');
    var printBtn=document.getElementById('print');
    var pdfBtn=document.getElementById('generatePDF');
    var receiptBtn=document.getElementById('receipt');
    var bookBtn=document.getElementById('bookkeeping');
    var closeBtn=document.getElementById('closeLedger');
    
    if(addBtn && !addBtn.hasAttribute('data-bound')){
      addBtn.addEventListener('click', onAdd);
      addBtn.setAttribute('data-bound', 'true');
    }
    if(clearBtn && !clearBtn.hasAttribute('data-bound')){
      clearBtn.addEventListener('click', onClear);
      clearBtn.setAttribute('data-bound', 'true');
    }
    if(printBtn && !printBtn.hasAttribute('data-bound')){
      printBtn.addEventListener('click', function(){ 
        try{ saveToLedger('silent'); generatePDF(); }catch(e){ showToast('PDF generation failed'); }
      });
      printBtn.setAttribute('data-bound', 'true');
    }
    if(pdfBtn && !pdfBtn.hasAttribute('data-bound')){
      pdfBtn.addEventListener('click', function(){ 
        try{ saveToLedger('silent'); window.print(); }catch(e){ showToast('Print failed'); }
      });
      pdfBtn.setAttribute('data-bound', 'true');
    }
    if(receiptBtn && !receiptBtn.hasAttribute('data-bound')){
      receiptBtn.addEventListener('click', function(){
        try{ generateReceiptJsPDF(); }catch(e){ showToast('Receipt generation failed'); }
      });
      receiptBtn.setAttribute('data-bound', 'true');
    }
    if(bookBtn && !bookBtn.hasAttribute('data-bound')){
      bookBtn.addEventListener('click', openLedger);
      bookBtn.setAttribute('data-bound', 'true');
    }
    if(closeBtn && !closeBtn.hasAttribute('data-bound')){
      closeBtn.addEventListener('click', function(){ 
        var overlay=document.getElementById('ledgerOverlay'); 
        if(overlay) overlay.style.display='none'; 
      });
      closeBtn.setAttribute('data-bound', 'true');
    }
  }catch(e){ 
    console.error('Button binding failed:', e);
    showToast('Some buttons may not work properly');
  }
}

(function authInit(){
  var loginScreen=document.getElementById('loginScreen');
  var pwd=document.getElementById('loginPassword');
  var submit=document.getElementById('loginSubmit');
  var error=document.getElementById('loginError');

  function tryLogin(){
    if((pwd && (pwd.value||'').trim()) === ACCESS_CODE){
      localStorage.setItem('btl_logged_in','1');
      if(loginScreen){
        loginScreen.style.display='none';
        // Remove from DOM to ensure it cannot block clicks
        if(loginScreen.parentNode){ loginScreen.parentNode.removeChild(loginScreen); }
      }
      // Rebind listeners after login
      setTimeout(rebindMainListeners, 100);
    } else {
      if(error){ error.textContent='Incorrect password'; error.style.display='block'; }
      if(pwd){ pwd.focus(); pwd.select && pwd.select(); }
    }
  }

  if(localStorage.getItem('btl_logged_in')==='1'){
    if(loginScreen){ loginScreen.style.display='none'; if(loginScreen.parentNode){ loginScreen.parentNode.removeChild(loginScreen); } }
    setTimeout(rebindMainListeners, 50);
  } else {
    if(loginScreen) loginScreen.style.display='flex';
  }

  submit && submit.addEventListener('click', function(e){ e.preventDefault(); tryLogin(); });
  pwd && pwd.addEventListener('keydown', function(e){ if(e.key==='Enter'){ e.preventDefault(); tryLogin(); }});
  window.logout = function(){ localStorage.removeItem('btl_logged_in'); location.reload(); };
})();

// Helpers
function gbp(n){ return new Intl.NumberFormat('en-GB',{style:'currency',currency:'GBP'}).format(Number(n||0)); }
function id(x){ return document.getElementById(x); }

// Elements
var invNo=id('invNo'), invDate=id('invDate'), dueDate=id('dueDate');
var clientName=id('clientName'), clientContact=id('clientContact');
var device=id('device'), service=id('service');
var desc=id('desc'), qty=id('qty'), price=id('price'), line=id('line');
var list=id('list'), subtotal=id('subtotal'), grand=id('grand');
var devType=id('devType'), devMake=id('devMake'), devModel=id('devModel');
var vatEnabled=id('vatEnabled'), vatRate=id('vatRate'), vatAmount=id('vatAmount');
var copyInvNo=id('copyInvNo'), vatWarning=id('vatWarning');
var customerDropdown=id('customerDropdown'), modelDropdown=id('modelDropdown');
var discountDesc=id('discountDesc'), discountAmount=id('discountAmount'), applyDiscount=id('applyDiscount');
var stickySubtotal=id('stickySubtotal'), stickyVat=id('stickyVat'), stickyTotal=id('stickyTotal');
var remark=id('remark');
var ledgerOverlay=id('ledgerOverlay'), closeLedger=id('closeLedger');
var ledgerStart=id('ledgerStart'), ledgerEnd=id('ledgerEnd');
var ledgerTable=id('ledgerTable'), ledgerTotals=id('ledgerTotals');
var markPaid=id('markPaid'), paidStamp=id('paidStamp');
var jobStatus=id('jobStatus');

// Data
var DEV_TYPES=['Phone','Tablet','Laptop','Desktop','Console','Watch','Other'];
var DEV_MAKES=['Apple','Samsung','Google','Huawei','OnePlus','Xiaomi','Sony','Nokia','Motorola','Dell','HP','Lenovo','Asus','Acer','Microsoft','Nintendo','Other'];

var CATALOG={
  "Repairs": {
    "Screen replacement": 89.99,
    "Battery replacement": 49.99,
    "Charging port repair": 39.99,
    "Water damage repair": 79.99,
    "Software issue": 30.00,
    "Diagnostic service": 20.00,
    "Board-level repair": 120.00,
    "Camera repair": 59.99,
    "Speaker/Mic repair": 39.99,
    "Back glass replacement": 89.99,
    "Data recovery": 120.00
  },
  "Sales": {
    "Tempered glass protector": 10.00,
    "Phone case": 10.00,
    "Charging cable": 8.00,
    "Wall charger": 15.00,
    "Power bank": 20.00,
    "Earphones/Headset": 15.00,
    "USB-C adapter": 12.00,
    "Lightning cable": 15.00,
    "Wireless charger": 25.00,
    "Laptop charger": 35.00,
    "Mouse/Keyboard": 25.00,
    "Memory card": 12.00,
    "USB drive": 8.00,
    "HDMI cable": 9.00,
    "Screen cleaner kit": 5.00,
    "Refurbished phone": 200.00,
    "Refurbished tablet": 180.00,
    "Refurbished laptop": 350.00
  }
};

// Device models by make (2017-2024)
var MODEL_CATALOG={
  "Apple":{
    "Phone":["iPhone 17 Pro Max","iPhone 17 Pro","iPhone 17","iPhone 17 Plus","iPhone 16 Pro Max","iPhone 16 Pro","iPhone 16","iPhone 16 Plus","iPhone 15 Pro Max","iPhone 15 Pro","iPhone 15","iPhone 15 Plus","iPhone 14 Pro Max","iPhone 14 Pro","iPhone 14","iPhone 14 Plus","iPhone 13 Pro Max","iPhone 13 Pro","iPhone 13","iPhone 13 mini","iPhone 12 Pro Max","iPhone 12 Pro","iPhone 12","iPhone 12 mini","iPhone 11 Pro Max","iPhone 11 Pro","iPhone 11","iPhone XS Max","iPhone XS","iPhone XR","iPhone X","iPhone 8 Plus","iPhone 8","iPhone 7 Plus","iPhone 7"],
    "Tablet":["iPad Air (2025)","iPad Pro 12.9 (2025)","iPad Pro 11 (2025)","iPad (2025)","iPad mini (2025)","iPad Pro 12.9 (2024)","iPad Pro 11 (2024)","iPad Air (2024)","iPad (2024)","iPad mini (2023)","iPad Pro 12.9 (2022)","iPad Pro 11 (2022)","iPad Air (2022)","iPad (2022)","iPad mini (2021)","iPad Pro 12.9 (2021)","iPad Pro 11 (2021)","iPad Air (2020)","iPad (2020)","iPad mini (2019)","iPad Pro 12.9 (2018)","iPad Pro 11 (2018)","iPad (2018)","iPad Pro 12.9 (2017)","iPad Pro 10.5 (2017)"],
    "Laptop":["MacBook Pro 16 (2024)","MacBook Pro 14 (2024)","MacBook Air 15 (2024)","MacBook Air 13 (2024)","MacBook Pro 16 (2023)","MacBook Pro 14 (2023)","MacBook Air 15 (2023)","MacBook Air 13 (2022)","MacBook Pro 16 (2021)","MacBook Pro 14 (2021)","MacBook Air 13 (2020)","MacBook Pro 16 (2019)","MacBook Pro 13 (2019)","MacBook Air 13 (2019)","MacBook Pro 15 (2018)","MacBook Pro 13 (2018)","MacBook Air 13 (2018)","MacBook Pro 15 (2017)","MacBook Pro 13 (2017)","MacBook Air 13 (2017)"]
  },
  "Samsung":{
    "Phone":["Galaxy S25 Ultra","Galaxy S25+","Galaxy S25","Galaxy S24 Ultra","Galaxy S24+","Galaxy S24","Galaxy S23 Ultra","Galaxy S23+","Galaxy S23","Galaxy S22 Ultra","Galaxy S22+","Galaxy S22","Galaxy S21 Ultra","Galaxy S21+","Galaxy S21","Galaxy S20 Ultra","Galaxy S20+","Galaxy S20","Galaxy Note 20 Ultra","Galaxy Note 20","Galaxy Note 10+","Galaxy Note 10","Galaxy A54","Galaxy A34","Galaxy A24","Galaxy A14","Galaxy A04s"],
    "Tablet":["Galaxy Tab S9 Ultra","Galaxy Tab S9+","Galaxy Tab S9","Galaxy Tab S8 Ultra","Galaxy Tab S8+","Galaxy Tab S8","Galaxy Tab S7+","Galaxy Tab S7","Galaxy Tab A8","Galaxy Tab A7 Lite"],
    "Laptop":["Galaxy Book4 Ultra","Galaxy Book4 Pro","Galaxy Book4","Galaxy Book3 Ultra","Galaxy Book3 Pro","Galaxy Book3","Galaxy Book2 Pro","Galaxy Book2","Galaxy Book Pro 360"]
  },
  "Google":{
    "Phone":["Pixel 8 Pro","Pixel 8","Pixel 7a","Pixel 7 Pro","Pixel 7","Pixel 6a","Pixel 6 Pro","Pixel 6","Pixel 5a","Pixel 5","Pixel 4a","Pixel 4","Pixel 3a","Pixel 3"],
    "Tablet":["Pixel Tablet","Pixel Slate"],
    "Laptop":["Pixelbook Go","Pixelbook","Chromebook Pixel"]
  },
  "Huawei":{
    "Phone":["P60 Pro","P60","P50 Pro","P50","P40 Pro","P40","P30 Pro","P30","Mate 60 Pro","Mate 50 Pro","Mate 40 Pro","Mate 40","Mate 30 Pro","Mate 30","Mate 20 Pro","Mate 20","Mate 10 Pro","Mate 10"],
    "Tablet":["MatePad Pro 12.6","MatePad Pro 11","MatePad 11","MatePad 10.4","MediaPad M6","MediaPad M5"],
    "Laptop":["MateBook X Pro","MateBook 14","MateBook 13","MateBook D 15","MateBook D 14"]
  },
  "OnePlus":{
    "Phone":["OnePlus 12","OnePlus 11","OnePlus 10 Pro","OnePlus 10T","OnePlus 9 Pro","OnePlus 9","OnePlus 8 Pro","OnePlus 8T","OnePlus 8","OnePlus 7T Pro","OnePlus 7T","OnePlus 7 Pro","OnePlus 7","OnePlus 6T","OnePlus 6","OnePlus 5T","OnePlus 5","Nord 3","Nord 2T","Nord 2","Nord CE 3","Nord CE 2"],
    "Tablet":["OnePlus Pad"],
    "Laptop":["OnePlus Book"]
  },
  "Xiaomi":{
    "Phone":["Xiaomi 14 Pro","Xiaomi 14","Xiaomi 13 Ultra","Xiaomi 13 Pro","Xiaomi 13","Xiaomi 12S Ultra","Xiaomi 12S Pro","Xiaomi 12S","Xiaomi 12 Pro","Xiaomi 12","Xiaomi 11 Ultra","Xiaomi 11 Pro","Xiaomi 11","Redmi Note 13 Pro","Redmi Note 13","Redmi Note 12 Pro","Redmi Note 12","Redmi Note 11 Pro","Redmi Note 11","Redmi Note 10 Pro","Redmi Note 10","POCO X6 Pro","POCO X5 Pro","POCO F5 Pro"],
    "Tablet":["Xiaomi Pad 6","Xiaomi Pad 5","Redmi Pad SE","Redmi Pad"],
    "Laptop":["Xiaomi Book S 12.4","Xiaomi Book Pro 16","Xiaomi Book Pro 14","Xiaomi Book Air 13"]
  },
  "Sony":{
    "Phone":["Xperia 1 V","Xperia 5 V","Xperia 10 V","Xperia 1 IV","Xperia 5 IV","Xperia 10 IV","Xperia 1 III","Xperia 5 III","Xperia 10 III","Xperia 1 II","Xperia 5 II","Xperia 10 II","Xperia 1","Xperia 5","Xperia 10","Xperia XZ3","Xperia XZ2"],
    "Tablet":["Xperia Tablet Z4","Xperia Tablet Z3"],
    "Laptop":["VAIO SX14","VAIO SX12","VAIO S11","VAIO Z","VAIO Pro"]
  },
  "Nokia":{
    "Phone":["Nokia XR21","Nokia G60","Nokia G50","Nokia G22","Nokia X30","Nokia X20","Nokia X10","Nokia 8.3","Nokia 7.2","Nokia 6.2","Nokia 5.3","Nokia 4.2","Nokia 3.4","Nokia 2.4","Nokia 1.4"],
    "Tablet":["Nokia T20","Nokia T10"],
    "Laptop":["Nokia PureBook X14","Nokia PureBook Pro"]
  },
  "Motorola":{
    "Phone":["Moto Edge 40 Pro","Moto Edge 40","Moto Edge 30 Pro","Moto Edge 30","Moto Edge 20 Pro","Moto Edge 20","Moto G84","Moto G73","Moto G62","Moto G54","Moto G53","Moto G52","Moto G51","Moto G42","Moto G32","Moto G22","Moto G13","Moto G04","Razr 40 Ultra","Razr 40","Razr 5G"],
    "Tablet":["Moto Tab G70","Moto Tab G62","Moto Tab G50"],
    "Laptop":["ThinkPad X1","ThinkPad T14","ThinkPad E14"]
  },
  "Dell":{
    "Phone":["Dell Streak","Dell Venue"],
    "Tablet":["Dell Latitude 7320 Detachable","Dell Venue 11 Pro","Dell Venue 8 Pro"],
    "Laptop":["XPS 13 Plus","XPS 13","XPS 15","XPS 17","Latitude 9440","Latitude 7440","Latitude 5440","Latitude 3440","Inspiron 16 Plus","Inspiron 15","Inspiron 14","Alienware m18","Alienware m16","Alienware x16","Alienware x14"]
  },
  "HP":{
    "Phone":["HP Elite x3"],
    "Tablet":["HP Elite x2","HP Pro x2","HP ElitePad","HP Slate"],
    "Laptop":["Spectre x360 16","Spectre x360 14","Spectre x360 13","EliteBook 1040","EliteBook 850","EliteBook 840","EliteBook 830","Pavilion Plus 14","Pavilion 15","Pavilion 14","Envy x360 15","Envy x360 13","Envy 16","Envy 15","Envy 14","Envy 13","Omen 17","Omen 16","Omen 15"]
  },
  "Lenovo":{
    "Phone":["Lenovo Legion Phone Duel","Lenovo K13","Lenovo K12","Lenovo K10"],
    "Tablet":["Yoga Tab 13","Yoga Tab 11","Yoga Tab 8","Tab P11 Pro","Tab P11","Tab M10 Plus","Tab M8","ThinkPad X1 Tablet"],
    "Laptop":["ThinkPad X1 Carbon Gen 11","ThinkPad X1 Yoga Gen 8","ThinkPad X1 Nano Gen 3","ThinkPad T16","ThinkPad T14","ThinkPad T14s","ThinkPad E16","ThinkPad E15","ThinkPad E14","IdeaPad 5 Pro 16","IdeaPad 5 Pro 14","IdeaPad 5 15","IdeaPad 5 14","IdeaPad 3 15","IdeaPad 3 14","Yoga 9i 16","Yoga 9i 14","Yoga 7i 16","Yoga 7i 14","Yoga 6 13","Legion 7i","Legion 5i","Legion 5 Pro"]
  },
  "Asus":{
    "Phone":["ROG Phone 7","ROG Phone 6","ROG Phone 5","ZenFone 10","ZenFone 9","ZenFone 8","ZenFone 7 Pro","ZenFone 7"],
    "Tablet":["ROG Flow Z13","VivoBook 13 Slate","ZenPad 10","ZenPad 8"],
    "Laptop":["ROG Zephyrus G16","ROG Zephyrus G14","ROG Zephyrus M16","ROG Zephyrus M15","ROG Strix G16","ROG Strix G15","ROG Flow X16","ROG Flow X13","ZenBook Pro 16X","ZenBook Pro 15","ZenBook 14X","ZenBook 14","ZenBook 13","VivoBook S15","VivoBook S14","VivoBook 15","VivoBook 14","ExpertBook B9","ExpertBook B7","ExpertBook B5","ExpertBook B3"]
  },
  "Acer":{
    "Phone":["Acer Liquid Z6","Acer Liquid Z5"],
    "Tablet":["Acer Iconia Tab 10","Acer Iconia Tab 8","Acer Iconia One 10","Acer Iconia One 8"],
    "Laptop":["Swift 5","Swift 3","Swift X","Aspire 7","Aspire 5","Aspire 3","Nitro 5","Nitro 16","Nitro 17","Predator Helios 16","Predator Helios 18","Predator Triton 16","Predator Triton 17","ConceptD 7","ConceptD 5","ConceptD 3","TravelMate P6","TravelMate P4","TravelMate P2"]
  },
  "Microsoft":{
    "Phone":["Surface Duo 2","Surface Duo"],
    "Tablet":["Surface Pro 9","Surface Pro 8","Surface Pro 7+","Surface Pro 7","Surface Pro X","Surface Go 4","Surface Go 3","Surface Go 2","Surface Go","Surface Studio 2+","Surface Studio 2"],
    "Laptop":["Surface Laptop Studio 2","Surface Laptop Studio","Surface Laptop 5","Surface Laptop 4","Surface Laptop 3","Surface Laptop 2","Surface Laptop Go 3","Surface Laptop Go 2","Surface Laptop Go","Surface Book 3","Surface Book 2"]
  },
  "Nintendo":{
    "Console":["Switch OLED","Switch (2019)","Switch Lite","Switch (2017)","3DS XL","3DS","2DS XL","2DS","Wii U","Wii"],
    "Tablet":["Switch (Tablet Mode)"],
    "Laptop":["Nintendo DS (Dual Screen)"]
  },
  "Other":{
    "Phone":["Other / Not listed"],
    "Tablet":["Other / Not listed"],
    "Laptop":["Other / Not listed"],
    "Desktop":["Other / Not listed"],
    "Console":["Other / Not listed"],
    "Watch":["Other / Not listed"]
  }
};

// State
var items=[];
var lastRemovedItem=null;
var customers=JSON.parse(localStorage.getItem('btl_customers')||'[]');
var lastDeviceSelection={type:'', make:'', model:''};
var invoiceLocked=false;
var LEDGER_KEY='btl_ledger_v1';

// Init
(function init(){
  // Invoice number and dates
  var now=new Date();
  var pad=function(n){ return String(n).padStart(2,'0'); };
  if(invDate) invDate.value = '2025-09-17';
  if(dueDate) dueDate.value = '2025-10-17';
  var seq = Number(localStorage.getItem('btl_seq')||0)+1; localStorage.setItem('btl_seq',seq);
  if(invNo) invNo.value = '2025-09-17-'+String(seq).padStart(4,'0');
  
  // Load last device selection
  var savedDevice = localStorage.getItem('btl_last_device');
  if(savedDevice) {
    try{
      lastDeviceSelection = JSON.parse(savedDevice);
      if(lastDeviceSelection.type && devType) devType.value = lastDeviceSelection.type;
      if(lastDeviceSelection.make && devMake) devMake.value = lastDeviceSelection.make;
    }catch(e){ console.error('Failed to load device selection:', e); }
  }

  // Populate service (names only, no prefilled prices)
  if(service){
    service.innerHTML = '<option value="">Select</option>';
    Object.keys(CATALOG).forEach(function(group){
      var og=document.createElement('optgroup'); og.label=group;
      Object.keys(CATALOG[group]).forEach(function(name){
        var o=document.createElement('option');
        o.value=name; o.textContent=name;
        og.appendChild(o);
      });
      service.appendChild(og);
    });
  }

  // Populate device selectors
  if(devType){
    DEV_TYPES.forEach(function(t){ var o=document.createElement('option'); o.value=t; o.textContent=t; devType.appendChild(o); });
  }
  if(devMake){
    DEV_MAKES.forEach(function(m){ var o=document.createElement('option'); o.value=m; o.textContent=m; devMake.appendChild(o); });
  }
  populateModels();

  // Listeners
  function recalc(){ 
    var q=Number(qty.value||0), p=Number(price.value||0);
    line.value = gbp(q*p);
    
    // Validation
    var qtyError = qty.parentNode.querySelector('.error');
    var priceError = price.parentNode.querySelector('.error');
    
    if(q < 1) {
      if(!qtyError) {
        qtyError = document.createElement('div');
        qtyError.className = 'error';
        qty.parentNode.appendChild(qtyError);
      }
      qtyError.textContent = 'Quantity must be at least 1';
      qty.classList.add('error');
    } else {
      if(qtyError) qtyError.remove();
      qty.classList.remove('error');
    }
    
    if(p < 0) {
      if(!priceError) {
        priceError = document.createElement('div');
        priceError.className = 'error';
        price.parentNode.appendChild(priceError);
      }
      priceError.textContent = 'Price cannot be negative';
      price.classList.add('error');
    } else {
      if(priceError) priceError.remove();
      price.classList.remove('error');
    }
  }
  if(qty) qty.addEventListener('input', recalc);
  if(price) price.addEventListener('input', recalc);
  recalc();

  // Device model search functionality
  function populateModels(){
    var make=devMake.value || 'Other';
    var type=devType.value || 'Phone';
    var models=(MODEL_CATALOG[make] && MODEL_CATALOG[make][type]) || MODEL_CATALOG['Other'][type] || MODEL_CATALOG['Other']['Phone'];
    
    // Store models for search
    devModel.dataset.models = JSON.stringify(models);
    
    // Set value if it exists in models
    if(lastDeviceSelection.model && models.includes(lastDeviceSelection.model)) {
      devModel.value = lastDeviceSelection.model;
    } else {
      devModel.value = '';
    }
    updateDevice();
  }
  
  function updateDevice(){ 
    device.value=[devType.value,devMake.value,devModel.value].filter(Boolean).join(' '); 
    
    // Save device selection
    lastDeviceSelection = {
      type: devType.value,
      make: devMake.value,
      model: devModel.value
    };
    localStorage.setItem('btl_last_device', JSON.stringify(lastDeviceSelection));
  }
  
  devType.addEventListener('change', function(){ populateModels(); updateDevice(); });
  devMake.addEventListener('change', function(){ populateModels(); updateDevice(); });
  
  // Model search functionality
  devModel.addEventListener('input', function(){
    var search = this.value.toLowerCase();
    var models = JSON.parse(this.dataset.models || '[]');
    var filtered = models.filter(function(m) { return m.toLowerCase().includes(search); });
    
    modelDropdown.innerHTML = '';
    if(filtered.length > 0 && search.length > 0) {
      filtered.forEach(function(model) {
        var option = document.createElement('div');
        option.className = 'model-option';
        option.textContent = model;
        option.addEventListener('click', function(){
          devModel.value = model;
          modelDropdown.style.display = 'none';
          updateDevice();
        });
        modelDropdown.appendChild(option);
      });
      modelDropdown.style.display = 'block';
    } else {
      modelDropdown.style.display = 'none';
    }
    updateDevice();
  });
  
  // Hide dropdowns when clicking outside
  document.addEventListener('click', function(e) {
    if(devModel && devModel.parentNode && !devModel.parentNode.contains(e.target)) modelDropdown.style.display = 'none';
    if(clientName && clientName.parentNode && !clientName.parentNode.contains(e.target)) customerDropdown.style.display = 'none';
  });

  service.addEventListener('change', function(){
    var name=service.value; if(!name) return;
    if(!desc.value) desc.value=name;
  });

  // VAT listeners
  vatEnabled && vatEnabled.addEventListener('change', function(){
    updateTotals();
    if(!this.checked) {
      vatWarning.style.display = 'block';
    } else {
      vatWarning.style.display = 'none';
    }
  });
  vatRate && vatRate.addEventListener('change', updateTotals);
  
  // Date validation
  invDate.addEventListener('change', function(){
    if(dueDate.value && new Date(dueDate.value) < new Date(this.value)) {
      dueDate.value = this.value;
    }
  });
  
  dueDate.addEventListener('change', function(){
    if(new Date(this.value) < new Date(invDate.value)) {
      this.classList.add('error');
      var error = this.parentNode.querySelector('.error');
      if(!error) {
        error = document.createElement('div');
        error.className = 'error';
        this.parentNode.appendChild(error);
      }
      error.textContent = 'Due date cannot be before invoice date';
    } else {
      this.classList.remove('error');
      var error = this.parentNode.querySelector('.error');
      if(error) error.remove();
    }
  });
  
  // Copy invoice number
  copyInvNo.addEventListener('click', function(){
    navigator.clipboard.writeText(invNo.value).then(function(){
      showToast('Invoice number copied!');
    });
  });
  
  // Customer search
  clientName.addEventListener('input', function(){
    var search = this.value.toLowerCase();
    var filtered = customers.filter(function(c) { return c.name.toLowerCase().includes(search); });
    
    customerDropdown.innerHTML = '';
    if(filtered.length > 0 && search.length > 0) {
      filtered.forEach(function(customer) {
        var option = document.createElement('div');
        option.className = 'customer-option';
        option.innerHTML = '<div class="customer-option-name">' + customer.name + '</div><div class="customer-option-contact">' + customer.contact + '</div>';
        option.addEventListener('click', function(){
          clientName.value = customer.name;
          clientContact.value = customer.contact;
          if(customer.vatEnabled !== undefined) vatEnabled.checked = customer.vatEnabled;
          if(customer.vatRate !== undefined) vatRate.value = customer.vatRate;
          customerDropdown.style.display = 'none';
          updateTotals();
        });
        customerDropdown.appendChild(option);
      });
      customerDropdown.style.display = 'block';
    } else {
      customerDropdown.style.display = 'none';
    }
  });
  
  // Auto-save customer when contact is filled
  clientContact.addEventListener('blur', autoSaveCustomer);
  
  // Discount functionality
  applyDiscount.addEventListener('click', function(){
    var desc = discountDesc.value;
    var amount = Number(discountAmount.value || 0);
    if(desc && amount > 0) {
      items.push({desc: desc, qty: 1, price: -amount, isDiscount: true});
      render();
      discountDesc.value = '';
      discountAmount.value = 0;
    }
  });
  
  // Keyboard shortcuts
  document.addEventListener('keydown', function(e){
    if(e.metaKey || e.ctrlKey) {
      switch(e.key) {
        case 'p': e.preventDefault(); window.print(); break;
        case 's': e.preventDefault(); saveToLedger(); break;
      }
    } else if(e.key === 'Enter' && (e.target === desc || e.target === qty || e.target === price)) {
      e.preventDefault();
      onAdd();
    } else if(e.key === 'Escape') {
      desc.value = ''; qty.value = 1; price.value = 0; recalc();
    }
  });

  rebindMainListeners();
  if(markPaid) markPaid.addEventListener('change', onTogglePaid);
  if(jobStatus) jobStatus.addEventListener('change', onStatusChange);
})();

// Actions
function onAdd(){
  var q=Number(qty.value||0), p=Number(price.value||0); if(q<=0) return;
  var selected=service && service.options && service.selectedIndex>0 ? service.options[service.selectedIndex] : null;
  var group=(selected && selected.parentElement && selected.parentElement.tagName==='OPTGROUP') ? selected.parentElement.label : '';
  var category=(group==='Sales') ? 'sales' : 'service';
  var item={desc: (desc.value||service.value||'Item'), qty:q, price:p, category:category};
  items.push(item);
  desc.value=''; qty.value=1; price.value=0; id('line').value='£0.00';
  render();
  saveToLedger('silent');
}
function onClear(){ items=[]; render(); }

function render(){
  list.innerHTML='';
  items.forEach(function(it, i){
    if(typeof it.cost === 'undefined') it.cost = 0;
    var row=document.createElement('div');
    row.className='row';
    var removeBtn = it.isDiscount ? 
      '<button class="icon-btn" title="Remove discount">🗑️</button>' :
      '<button class="icon-btn" title="Remove item">🗑️</button>';
    row.innerHTML= ''
      + '<input value="'+escapeHtml(it.desc)+'"' + (it.isDiscount ? ' class="discount-item"' : '') + '>'
      + '<input type="number" min="1" value="'+it.qty+'">'
      + '<input type="number" min="0" step="0.01" value="'+it.price+'">'
      + '<input type="number" min="0" step="0.01" value="'+(it.cost||0)+'" title="Cost per unit">'
      + '<input disabled value="'+gbp(it.qty*it.price)+'">'
      + removeBtn;
    var controls=row.querySelectorAll('input,button');
    var d=controls[0], q=controls[1], p=controls[2], c=controls[3], outs=controls[4], rm=controls[5];
    d.addEventListener('input', function(e){ it.desc=e.target.value; });
    q.addEventListener('input', function(e){ it.qty=Number(e.target.value||0); updateTotals(); });
    p.addEventListener('input', function(e){ it.price=Number(e.target.value||0); updateTotals(); });
    c.addEventListener('input', function(e){ it.cost=Number(e.target.value||0); updateTotals(); });
    rm.addEventListener('click', function(){ 
      lastRemovedItem = {item: JSON.parse(JSON.stringify(it)), index: i};
      items.splice(i,1); 
      render();
      showUndoToast();
    });
    list.appendChild(row);
  });
  updateTotals();
}

function updateTotals(){
  var sub=0, costSum=0;
  items.forEach(function(it){ sub+=it.qty*it.price; costSum += (Number(it.cost||0) * Number(it.qty||0)); });
  subtotal.textContent=gbp(sub);
  var rate = (vatEnabled && vatEnabled.checked) ? Number(vatRate.value||0) : 0;
  var vat = sub * (rate/100);
  if(vatAmount) vatAmount.textContent=gbp(vat);
  grand.textContent=gbp(sub + vat);
  
  // Update sticky totals
  if(stickySubtotal) stickySubtotal.textContent = gbp(sub);
  if(stickyVat) stickyVat.textContent = gbp(vat);
  if(stickyTotal) stickyTotal.textContent = gbp(sub + vat);
  
  Array.prototype.forEach.call(list.querySelectorAll('.row'), function(row, idx){
    var outs=row.querySelectorAll('input')[4];
    outs.value=gbp(items[idx].qty*items[idx].price);
  });
}

function onTogglePaid(){
  var isPaid = markPaid && markPaid.checked;
  if(paidStamp) paidStamp.style.display = isPaid ? 'block' : 'none';
  var page=document.querySelector('.page');
  if(page){ if(isPaid) page.classList.add('is-paid'); else page.classList.remove('is-paid'); }
  saveToLedger('silent');
}

// Ledger helpers
function currentInvoiceRecord(){
  var sub=0, discounts=0, sales=0, serviceSum=0, costSum=0;
  items.forEach(function(it){
    var val=it.qty*it.price; sub+=val; if(it.isDiscount) discounts+=val; else { if(it.category==='sales') sales+=val; else serviceSum+=val; }
    costSum += (Number(it.cost||0) * Number(it.qty||0));
  });
  var rate=(vatEnabled && vatEnabled.checked)? Number(vatRate.value||0):0;
  var vat=sub*(rate/100);
  var isPaid = markPaid && markPaid.checked;
  return {
    date: invDate.value,
    dueDate: dueDate.value || '',
    invoice: invNo.value,
    customer: clientName.value || '',
    contact: (clientContact && clientContact.value) || '',
    device: (device && device.value) || '',
    sales: Number(sales.toFixed(2)),
    service: Number(serviceSum.toFixed(2)),
    discounts: Number(discounts.toFixed(2)),
    vat: Number(vat.toFixed(2)),
    total: Number((sub+vat).toFixed(2)),
    cost: Number(costSum.toFixed(2)),
    profit: Number((sub - Math.abs(discounts) - costSum).toFixed(2)),
    paid: !!isPaid,
    status: jobStatus ? jobStatus.value : 'received'
  };
}

function saveToLedger(trigger){
  try{
    var rec=currentInvoiceRecord();
    var ledger=JSON.parse(localStorage.getItem(LEDGER_KEY)||'[]');
    var idx=ledger.findIndex(function(r){ return r.invoice===rec.invoice; });
    if(idx>=0) ledger[idx]=rec; else ledger.push(rec);
    localStorage.setItem(LEDGER_KEY, JSON.stringify(ledger));
    if(trigger!=='silent') showToast('Saved to ledger');
  }catch(e){ console.error('Ledger save failed', e); }
}

function openLedger(){
  populateLedger();
  ledgerOverlay.style.display='flex';
}

function populateLedger(){
  var ledger=JSON.parse(localStorage.getItem(LEDGER_KEY)||'[]');
  var start=ledgerStart.value? new Date(ledgerStart.value):null;
  var end=ledgerEnd.value? new Date(ledgerEnd.value):null;
  var paidFilter=(document.getElementById('filterPaid')||{}).value||'all';
  var customerFilter=(document.getElementById('filterCustomer')||{}).value||'';
  var deviceFilter=(document.getElementById('filterDevice')||{}).value||'';
  var filtered=ledger.filter(function(r){
    if(start && new Date(r.date) < start) return false;
    if(end && new Date(r.date) > end) return false;
    if(paidFilter==='paid' && !r.paid) return false;
    if(paidFilter==='unpaid' && r.paid) return false;
    if(customerFilter && !(r.customer||'').toLowerCase().includes(customerFilter.toLowerCase())) return false;
    if(deviceFilter && !(r.device||'').toLowerCase().includes(deviceFilter.toLowerCase())) return false;
    return true;
  });
  ledgerTable.innerHTML='';
  var totals={sales:0, service:0, discounts:0, vat:0, total:0, cost:0, profit:0, paidAmt:0, unpaidAmt:0, paidCount:0, unpaidCount:0};
  filtered.forEach(function(r){
    totals.sales+=r.sales||0; totals.service+=r.service||0; totals.discounts+=r.discounts||0; totals.vat+=r.vat||0; totals.total+=r.total||0; totals.cost+=(r.cost||0); totals.profit+=(r.profit||((r.sales+r.service)-(Math.abs(r.discounts||0))));
    if(r.paid){ totals.paidAmt+=r.total||0; totals.paidCount++; } else { totals.unpaidAmt+=r.total||0; totals.unpaidCount++; }
    var tr=document.createElement('tr');
    var remind='';
    if(!r.paid && r.contact && r.contact.indexOf('@')>0){
      var subject=encodeURIComponent('Payment reminder for invoice '+(r.invoice||''));
      var body=encodeURIComponent('Dear '+(r.customer||'')+"%0D%0A%0D%0AThis is a friendly reminder that invoice "+(r.invoice||'')+" dated "+(r.date||'')+" remains outstanding. Amount due: "+gbp(r.total||0)+".%0D%0A%0D%0AThank you,%0D%0ABTLTech Ltd");
      remind='<a href="mailto:'+r.contact+'?subject='+subject+'&body='+body+'">Remind</a>';
    }
    tr.innerHTML='<td>'+escapeHtml(r.date||'')+'</td>'+
      '<td>'+escapeHtml(r.invoice||'')+'</td>'+
      '<td>'+escapeHtml(r.customer||'')+'</td>'+
      '<td>'+gbp(r.sales||0)+'</td>'+
      '<td>'+gbp(r.service||0)+'</td>'+
      '<td>'+gbp(r.discounts||0)+'</td>'+
      '<td>'+gbp(r.vat||0)+'</td>'+
      '<td>'+gbp(r.total||0)+' '+(r.paid?'✅':'❌')+'</td>'+
      '<td>'+(remind||'')+'</td>';
    ledgerTable.appendChild(tr);
  });
  var net=totals.total - totals.vat;
  var marginBase=(totals.sales+totals.service - Math.abs(totals.discounts));
  var marginPct = marginBase>0 ? ((totals.profit / marginBase)*100) : 0;
  var box1 = totals.vat; // VAT due on sales
  var box6 = net; // value of supplies excluding VAT
  // Aging buckets for unpaid
  var today=new Date(); var a0=0,a30=0,a60=0,a90=0;
  filtered.forEach(function(r){ if(r.paid) return; var dd=r.dueDate? new Date(r.dueDate):null; if(!dd) return; var days=Math.floor((today - dd)/(1000*60*60*24)); if(days<=0) a0++; else if(days<=30) a30++; else if(days<=60) a60++; else a90++; });
  ledgerTotals.innerHTML=''
    +'<div><strong>Revenue:</strong> '+gbp(totals.total)+'</div>'
    +'<div><strong>VAT:</strong> '+gbp(totals.vat)+'</div>'
    +'<div><strong>Discounts:</strong> '+gbp(totals.discounts)+'</div>'
    +'<div><strong>Paid:</strong> '+gbp(totals.paidAmt)+' ('+totals.paidCount+')</div>'
    +'<div><strong>Unpaid:</strong> '+gbp(totals.unpaidAmt)+' ('+totals.unpaidCount+')</div>';
  document.getElementById('ledgerKpis').innerHTML=''
    +'<div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;">'
    +'  <div class="box"><div><strong>Cost</strong></div><div>'+gbp(totals.cost)+'</div></div>'
    +'  <div class="box"><div><strong>Profit</strong></div><div>'+gbp(totals.profit)+'</div></div>'
    +'  <div class="box"><div><strong>Margin%</strong></div><div>'+marginPct.toFixed(1)+'%</div></div>'
    +'  <div class="box"><div><strong>VAT Box 1 / Box 6</strong></div><div>'+gbp(box1)+' / '+gbp(box6)+'</div></div>'
    +'</div>'
    +'<div style="margin-top:8px"><strong>Aging (unpaid):</strong> 0d:'+a0+' · 1–30:'+a30+' · 31–60:'+a60+' · 61–90+:'+a90+'</div>';
  // Trends
  var byMonth={}; var salesVs={sales:0,service:0};
  filtered.forEach(function(r){ var m=(r.date||'').slice(0,7); if(!byMonth[m]) byMonth[m]=0; byMonth[m]+= (r.total||0); salesVs.sales += (r.sales||0); salesVs.service += (r.service||0); });
  var months=Object.keys(byMonth).sort(); var max=0; months.forEach(function(m){ if(byMonth[m]>max) max=byMonth[m]; });
  var bars=months.map(function(m){ var w=max? Math.max(2, Math.round((byMonth[m]/max)*100)) : 0; return '<div style="display:flex;align-items:center;gap:8px;"><div style="width:60px">'+m+'</div><div style="background:#dbeafe;height:10px;width:'+w+'%"></div><div>'+gbp(byMonth[m])+'</div></div>'; }).join('');
  var svcTotal = salesVs.sales + salesVs.service; var sw = svcTotal? Math.round((salesVs.sales/svcTotal)*100):0; var svw=100-sw;
  document.getElementById('ledgerCharts').innerHTML=''
    +'<div><strong>Monthly revenue</strong></div>'
    +'<div style="display:flex;flex-direction:column;gap:4px;margin:6px 0;">'+bars+'</div>'
    +'<div style="margin-top:8px"><strong>Sales vs Service</strong></div>'
    +'<div style="display:flex;height:12px;background:#eef2ff;border-radius:6px;overflow:hidden;margin:6px 0;">'
    +'  <div title="Sales" style="width:'+sw+'%;background:#60a5fa"></div>'
    +'  <div title="Service" style="width:'+svw+'%;background:#34d399"></div>'
    +'</div>'
    +'<div style="font-size:12px;color:#64748b">Sales '+gbp(salesVs.sales)+' · Service '+gbp(salesVs.service)+'</div>';
}

ledgerStart && ledgerStart.addEventListener('change', populateLedger);
ledgerEnd && ledgerEnd.addEventListener('change', populateLedger);
document.getElementById('filterPaid') && document.getElementById('filterPaid').addEventListener('change', populateLedger);
document.getElementById('filterCustomer') && document.getElementById('filterCustomer').addEventListener('input', populateLedger);
document.getElementById('filterDevice') && document.getElementById('filterDevice').addEventListener('input', populateLedger);

function exportCSV(){
  var ledger=JSON.parse(localStorage.getItem(LEDGER_KEY)||'[]');
  var rows=[["Date","Invoice","Customer","Sales","Service","Discounts","VAT","Total"]];
  ledger.forEach(function(r){
    rows.push([r.date,r.invoice,r.customer,r.sales,r.service,r.discounts,r.vat,r.total]);
  });
  var csv=rows.map(function(row){ return row.map(function(x){
    var s=String(x);
    if(s.includes(',')||s.includes('"')||s.includes('\n')) s='"'+s.replace(/"/g,'""')+'"';
    return s;
  }).join(','); }).join('\n');
  var blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});
  var url=URL.createObjectURL(blob);
  var a=document.createElement('a'); a.href=url; a.download='btltech-ledger.csv'; a.click(); URL.revokeObjectURL(url);
}
id('exportCsv') && id('exportCsv').addEventListener('click', exportCSV);

// Status
function onStatusChange(){
  saveToLedger('silent');
}



function generateReceipt(){
  console.log('🧾 Starting receipt generation...');
  
  // Debug: Check if elements exist
  console.log('Elements check:', {
    invNo: !!invNo,
    invDate: !!invDate,
    clientName: !!clientName,
    clientContact: !!clientContact
  });

  // Get all data with debugging
  var invoiceNum = (invNo && invNo.value) || 'RECEIPT-' + new Date().getTime();
  var invoiceDate = (invDate && invDate.value) || new Date().toISOString().split('T')[0];
  var customerName = (clientName && clientName.value) || 'Walk-in Customer';
  var customerContact = (clientContact && clientContact.value) || 'Not provided';
  var customerEmail = customerContact.includes('@') ? customerContact : '';
  var customerPhone = !customerContact.includes('@') ? customerContact : '';

  // Device information
  var deviceType = (devType && devType.value) || '';
  var deviceMake = (devMake && devMake.value) || '';
  var deviceModel = (devModel && devModel.value) || '';
  var deviceInfo = [deviceType, deviceMake, deviceModel].filter(Boolean).join(' ') || 'Not specified';
  
  var devSerial = (document.getElementById('devSerial') && document.getElementById('devSerial').value) || 'Not specified';
  var devCondition = (document.getElementById('devCondition') && document.getElementById('devCondition').value) || 'Not assessed';
  var reportedFault = (document.getElementById('reportedFault') && document.getElementById('reportedFault').value) || 'Not specified';
  var devAccessories = (document.getElementById('devAccessories') && document.getElementById('devAccessories').value) || '';
  var staffName = (document.getElementById('staffName') && document.getElementById('staffName').value) || '';
  var staffInitials = (document.getElementById('staffInitials') && document.getElementById('staffInitials').value) || (staffName ? staffName.split(' ').map(function(n){return n[0]||''}).join('').toUpperCase() : 'Staff');
  var remarks = (remark && remark.value) || '';

  console.log('📋 Receipt data:', {
    invoiceNum, invoiceDate, customerName, customerContact, deviceInfo, devSerial, reportedFault, staffInitials
  });

  // Calculate totals and build services table
  var subtotal = 0;
  var serviceRows = '';
  if(items && items.length > 0) {
    items.forEach(function(item, index){
      if(index < 6) { // Limit to 6 items for space
        var amount = item.qty * item.price;
        subtotal += amount;
        serviceRows += `
          <tr>
            <td style="border:1px solid #ddd; padding:4px; font-size:9pt;">${escapeHtml(item.desc || 'Service')}</td>
            <td style="border:1px solid #ddd; padding:4px; text-align:center; font-size:9pt;">${item.qty || 1}</td>
            <td style="border:1px solid #ddd; padding:4px; text-align:right; font-size:9pt;">${gbp(amount)}</td>
          </tr>`;
      }
    });
    if(items.length > 6) {
      serviceRows += `
        <tr>
          <td colspan="3" style="border:1px solid #ddd; padding:4px; text-align:center; font-style:italic; color:#666; font-size:9pt;">
            +${items.length - 6} additional services (see full invoice)
          </td>
        </tr>`;
    }
  } else {
    serviceRows = `
      <tr>
        <td colspan="3" style="border:1px solid #ddd; padding:8px; text-align:center; color:#666; font-size:9pt;">
          Diagnostic / Assessment only
        </td>
      </tr>`;
  }

  // Create comprehensive receipt HTML
  var receiptHtml = `
    <div style="width:148mm; margin:0; padding:8mm; box-sizing:border-box; font-family:Arial,sans-serif; font-size:10pt; background:white; color:#000; position:relative;">
      
      <!-- Header -->
      <div style="text-align:center; border-bottom:2px solid #333; padding-bottom:8mm; margin-bottom:6mm;">
        <div style="display:flex; align-items:center; justify-content:center; gap:8mm; margin-bottom:4mm;">
          <img src="logo.jpeg" alt="BTLTech Logo" style="height:25mm; width:auto; object-fit:contain;" onerror="this.style.display='none'">
          <div>
            <h1 style="margin:0; font-size:18pt; font-weight:bold; color:#333;">BTLTech Ltd</h1>
            <p style="margin:2mm 0 0 0; font-size:9pt; color:#666;">Professional Device Repair Services</p>
          </div>
        </div>
        <div style="font-size:9pt; color:#666; line-height:1.3;">
          123 High Street, London W12 3AB<br>
          📧 info@btltech.co.uk | 📞 020 8746 0193 | 📱 07445 363599 · 🌐 www.btltech.co.uk
        </div>
      </div>

      <!-- Receipt Details -->
      <div style="background:#f8f9fa; border:1px solid #ddd; border-radius:4mm; padding:4mm; margin-bottom:6mm;">
        <h2 style="margin:0 0 3mm 0; font-size:14pt; color:#d63384; text-align:center; font-weight:bold;">📋 JOB DROP-OFF RECEIPT</h2>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:3mm; font-size:10pt;">
          <div><strong>Receipt #:</strong> ${escapeHtml(invoiceNum)}</div>
          <div><strong>Date:</strong> ${escapeHtml(invoiceDate)}</div>
          <div><strong>Staff:</strong> ${escapeHtml(staffName || staffInitials)}</div>
          <div><strong>Status:</strong> <span style="color:#0066cc; font-weight:bold;">RECEIVED</span></div>
        </div>
      </div>

      <!-- Customer Details -->
      <div style="border:1px solid #ddd; border-radius:4mm; padding:4mm; margin-bottom:5mm;">
        <h3 style="margin:0 0 3mm 0; font-size:11pt; color:#333; border-bottom:1px solid #eee; padding-bottom:2mm;">👤 Customer Information</h3>
        <div style="font-size:10pt; line-height:1.4;">
          <div><strong>Name:</strong> ${escapeHtml(customerName)}</div>
          ${customerPhone ? `<div><strong>Phone:</strong> ${escapeHtml(customerPhone)}</div>` : ''}
          ${customerEmail ? `<div><strong>Email:</strong> ${escapeHtml(customerEmail)}</div>` : ''}
          ${!customerPhone && !customerEmail ? `<div><strong>Contact:</strong> ${escapeHtml(customerContact)}</div>` : ''}
        </div>
      </div>

      <!-- Device Details -->
      <div style="border:1px solid #ddd; border-radius:4mm; padding:4mm; margin-bottom:5mm;">
        <h3 style="margin:0 0 3mm 0; font-size:11pt; color:#333; border-bottom:1px solid #eee; padding-bottom:2mm;">📱 Device Information</h3>
        <div style="font-size:10pt; line-height:1.4;">
          <div><strong>Device:</strong> ${escapeHtml(deviceInfo)}</div>
          <div><strong>Serial/IMEI:</strong> ${escapeHtml(devSerial)}</div>
          <div><strong>Condition on Arrival:</strong> ${escapeHtml(devCondition)}</div>
        ${devAccessories ? `<div><strong>Accessories left:</strong> ${escapeHtml(devAccessories)}</div>` : ''}
          <div style="margin-top:2mm;"><strong>Reported Problem:</strong></div>
          <div style="background:#fff3cd; border:1px solid #ffeaa7; border-radius:3mm; padding:3mm; margin-top:1mm; font-style:italic;">
            "${escapeHtml(reportedFault)}"
          </div>
          ${remarks ? `<div style="margin-top:2mm;"><strong>Additional Notes:</strong> ${escapeHtml(remarks)}</div>` : ''}
        </div>
      </div>

      <!-- Services/Estimate -->
      <div style="border:1px solid #ddd; border-radius:4mm; padding:4mm; margin-bottom:5mm;">
        <h3 style="margin:0 0 3mm 0; font-size:11pt; color:#333; border-bottom:1px solid #eee; padding-bottom:2mm;">🔧 Service Details</h3>
        <div style="font-size:10pt; line-height:1.4; margin-bottom:3mm;">
          <div><strong>Reported issue:</strong> ${escapeHtml(reportedFault)}</div>
          ${remarks ? `<div><strong>Notes:</strong> ${escapeHtml(remarks)}</div>` : ''}
        </div>
        <table style="width:100%; border-collapse:collapse; margin-top:2mm;">
          <thead>
            <tr style="background:#f1f3f4;">
              <th style="border:1px solid #ddd; padding:4mm; text-align:left; font-size:9pt;">Description</th>
              <th style="border:1px solid #ddd; padding:4mm; text-align:center; font-size:9pt; width:15mm;">Qty</th>
              <th style="border:1px solid #ddd; padding:4mm; text-align:right; font-size:9pt; width:20mm;">Price</th>
            </tr>
          </thead>
          <tbody>
            ${serviceRows}
          </tbody>
        </table>
        <div style="text-align:right; margin-top:3mm; font-size:12pt; font-weight:bold; color:#0066cc;">
          ESTIMATED TOTAL: ${gbp(subtotal)}
        </div>
        <div style="font-size:8pt; color:#666; text-align:center; margin-top:2mm; font-style:italic;">
          *Final cost may vary based on actual work required
        </div>
      </div>

      <!-- Terms & Conditions -->
      <div style="border:1px solid #ddd; border-radius:4mm; padding:4mm; margin-bottom:8mm; font-size:8pt; line-height:1.3;">
        <h4 style="margin:0 0 2mm 0; font-size:9pt; color:#333;">📋 Terms & Conditions</h4>
        <div style="column-count:1;">
          • <strong>Warranty:</strong> 30-day warranty on completed repairs (excludes accidental/liquid damage)<br>
          • <strong>Data:</strong> Data recovery not guaranteed - backup your data regularly<br>
          • <strong>Collection:</strong> Devices not collected within 60 days may be sold/recycled to recover costs<br>
          • <strong>Liability:</strong> Liability limited to repair cost - BTLTech Ltd not liable for data loss<br>
          • <strong>Payment:</strong> Payment due on completion - cash, card, or bank transfer accepted<br>
          • <strong>Estimates:</strong> Estimates valid for 30 days and subject to change upon diagnosis
        </div>
      </div>

      <!-- Signature Section -->
      <div style="position:absolute; bottom:8mm; left:8mm; right:8mm;">
        <div style="border-top:2px solid #333; padding-top:4mm;">
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:8mm; font-size:9pt;">
            <div>
              <div style="border-bottom:1px solid #666; height:8mm; margin-bottom:2mm;"></div>
              <div style="text-align:center;"><strong>Customer Signature</strong></div>
              <div style="text-align:center; font-size:8pt; color:#666;">I acknowledge receipt of this job sheet</div>
            </div>
            <div>
              <div style="border-bottom:1px solid #666; height:8mm; margin-bottom:2mm;"></div>
              <div style="text-align:center;"><strong>Staff Signature (${escapeHtml(staffInitials)})</strong></div>
              <div style="text-align:center; font-size:8pt; color:#666;">Device received in described condition</div>
            </div>
          </div>
        </div>
      </div>

    </div>
  `;

  console.log('✅ Receipt HTML generated, creating PDF...');

  // Create temporary container
  var tempContainer = document.createElement('div');
  tempContainer.style.cssText = 'position:fixed; top:-9999px; left:-9999px; z-index:-1;';
  tempContainer.innerHTML = receiptHtml;
  document.body.appendChild(tempContainer);
  var receiptElement = tempContainer.firstElementChild;

  // PDF generation options
  var options = {
    margin: [3, 3, 3, 3],
    filename: `BTLTech-Receipt-${invoiceNum}.pdf`,
    image: { type: 'jpeg', quality: 0.95 },
    html2canvas: { 
      scale: 2,
      useCORS: false,
      allowTaint: true,
      backgroundColor: '#ffffff',
      logging: false
    },
    jsPDF: { 
      unit: 'mm', 
      format: 'a5', 
      orientation: 'portrait' 
    },
    pagebreak: { mode: ['css','legacy'] }
  };

  // Generate PDF
  html2pdf().from(receiptElement).set(options)
    .save()
    .then(function(){
      console.log('✅ Receipt PDF generated successfully!');
      showToast('Receipt generated successfully!');
    })
    .catch(function(error){
      console.error('❌ Receipt generation failed:', error);
      showToast('Receipt generation failed. Please try again.');
    })
    .finally(function(){
      if(tempContainer && tempContainer.parentNode) {
        document.body.removeChild(tempContainer);
      }
    });
}

// Auto-save customer data
function autoSaveCustomer(){
  if(clientName.value && clientContact.value) {
    var existingCustomer = customers.find(function(c) { return c.name === clientName.value; });
    if(!existingCustomer) {
      customers.push({
        name: clientName.value,
        contact: clientContact.value,
        vatEnabled: vatEnabled.checked,
        vatRate: vatRate.value
      });
      localStorage.setItem('btl_customers', JSON.stringify(customers));
    }
  }
}
function generatePDF() {
  const btn = id('generatePDF');
  if(!btn) return;
  
  btn.textContent = 'Generating...';
  btn.disabled = true;

  const watermark = document.querySelector('.watermark');
  const stickyTotals = document.querySelector('.sticky-totals');
  if (watermark) watermark.style.display = 'block';
  if (stickyTotals) stickyTotals.style.display = 'none';

  const element = document.querySelector('.page');
  if(!element) {
    showToast('Cannot find invoice content');
    btn.textContent = 'Generate PDF';
    btn.disabled = false;
    return;
  }
  
  const pageEl = element;
  const prevMinHeight = pageEl && pageEl.style.minHeight;
  const prevMaxHeight = pageEl && pageEl.style.maxHeight;
  const prevOverflow = pageEl && pageEl.style.overflow;
  // Removed forced height and overflow setting to allow pagination
  // ... existing code ...
  const cleanup = () => {
    if (watermark) watermark.style.display = 'none';
    if (stickyTotals) stickyTotals.style.display = 'block';
    btn.textContent = 'Generate PDF';
    btn.disabled = false;
    if(pageEl){ 
      pageEl.style.minHeight = prevMinHeight || ''; 
      pageEl.style.maxHeight = prevMaxHeight || '';
      pageEl.style.overflow = prevOverflow || '';
    }
  };

  const options = {
    margin: [8, 8, 8, 8],
    filename: `BTLTech-Invoice-${invNo.value || 'invoice'}.pdf`,
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: {
      scale: 1,
      useCORS: false,
      allowTaint: true,
      backgroundColor: '#ffffff',
      letterRendering: true,
      scrollY: 0,
      // Let html2pdf paginate naturally without fixed bitmap size
      ignoreElements: function(el){
        try{
          if(!el) return false;
          if(el.id && ['print','generatePDF','email','applyDiscount','clear','add','bookkeeping','receipt'].indexOf(el.id) !== -1) return true;
          if(el.classList && (el.classList.contains('toolbar') || el.classList.contains('no-print') || el.classList.contains('copy-icon') || el.classList.contains('primary-add') || el.classList.contains('mark-paid-section'))) return true;
          var p=el.parentElement;
          while(p){
            if(p.classList && (p.classList.contains('toolbar') || p.classList.contains('no-print'))) return true;
            p=p.parentElement;
          }
          return false;
        }catch(e){ return false; }
      }
    },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait', putOnlyUsedFonts: true },
    pagebreak: { mode: ['css', 'legacy'], avoid: ['.banking-details', '.note', '.row', '.box', '.totals', '.grid-2', '.grid-3'], before: '.page-break' }
  };

  // enforce centered layout just for export
  document.documentElement.classList.add('pdf-export');
  html2pdf().from(element).set(options).save()
    .then(() => { saveToLedger('silent'); showToast('PDF downloaded successfully!'); cleanup(); })
    .catch((error) => { console.error('PDF Generation Failed:', error); showToast('PDF failed. Use Print as fallback.'); cleanup(); })
    .finally(() => { document.documentElement.classList.remove('pdf-export'); });
}



// Utils
function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, function(m){
    return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]);
  });
}

function showToast(message){
  var toast = document.createElement('div');
  toast.className = 'toast';
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(function(){
    toast.remove();
  }, 3000);
}

function showUndoToast(){
  var toast = document.createElement('div');
  toast.className = 'toast';
  toast.innerHTML = 'Item removed <button onclick="undoRemove()" class="undo-btn">Undo</button>';
  document.body.appendChild(toast);
  setTimeout(function(){
    toast.remove();
  }, 5000);
}

function undoRemove(){
  if(lastRemovedItem) {
    items.splice(lastRemovedItem.index, 0, lastRemovedItem.item);
    render();
    lastRemovedItem = null;
    showToast('Item restored!');
  }
}

function exportJSON(){
  var data={ ledger: JSON.parse(localStorage.getItem(LEDGER_KEY)||'[]'), customers: JSON.parse(localStorage.getItem('btl_customers')||'[]') };
  var blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
  var url=URL.createObjectURL(blob);
  var a=document.createElement('a'); a.href=url; a.download='btltech-backup.json'; a.click(); URL.revokeObjectURL(url);
}
function importJSONFile(file){
  var reader=new FileReader();
  reader.onload=function(){
    try{ var data=JSON.parse(reader.result||'{}');
      if(Array.isArray(data.ledger)) localStorage.setItem(LEDGER_KEY, JSON.stringify(data.ledger));
      if(Array.isArray(data.customers)) localStorage.setItem('btl_customers', JSON.stringify(data.customers));
      showToast('Data restored'); populateLedger();
    }catch(e){ showToast('Invalid JSON'); }
  };
  reader.readAsText(file);
}

document.getElementById('exportJson') && document.getElementById('exportJson').addEventListener('click', exportJSON);
document.getElementById('importJsonBtn') && document.getElementById('importJsonBtn').addEventListener('click', function(){ var f=document.getElementById('importJson'); f && f.click(); });
document.getElementById('importJson') && document.getElementById('importJson').addEventListener('change', function(e){ var f=e.target.files && e.target.files[0]; if(f) importJSONFile(f); });

document.getElementById('resetData') && document.getElementById('resetData').addEventListener('click', function(){
  if(confirm('Reset ledger data? This cannot be undone.')){
    localStorage.removeItem(LEDGER_KEY);
    if(confirm('Also remove saved customers?')){ localStorage.removeItem('btl_customers'); }
    showToast('Data reset'); populateLedger();
  }
});

// Programmatic jsPDF receipt generator (ReportLab-style)
function generateReceiptJsPDF(){
  var jspdfNS = window.jspdf;
  if(!jspdfNS || !jspdfNS.jsPDF){ showToast('PDF engine not loaded'); return; }

  // Inputs
  var invoiceNum = (invNo && invNo.value) || 'RECEIPT-' + Date.now();
  var invoiceDate = (invDate && invDate.value) || new Date().toISOString().slice(0,10);
  var customerName = (clientName && clientName.value) || 'Walk-in Customer';
  var contactRaw = (clientContact && clientContact.value) || '';
  var customerEmail = contactRaw.indexOf('@')>=0 ? contactRaw : '';
  var customerPhone = contactRaw.indexOf('@')<0 ? contactRaw : '';
  var deviceType = (devType && devType.value) || '';
  var deviceMake = (devMake && devMake.value) || '';
  var deviceModel = (devModel && devModel.value) || '';
  var deviceInfo = [deviceType, deviceMake, deviceModel].filter(Boolean).join(' ');
  var devSerial = (document.getElementById('devSerial') && document.getElementById('devSerial').value) || '';
  var devCondition = (document.getElementById('devCondition') && document.getElementById('devCondition').value) || '';
  var devAccessories = (document.getElementById('devAccessories') && document.getElementById('devAccessories').value) || '';
  var reportedFault = (document.getElementById('reportedFault') && document.getElementById('reportedFault').value) || '';
  var staffName = (document.getElementById('staffName') && document.getElementById('staffName').value) || '';
  var staffInitials = (document.getElementById('staffInitials') && document.getElementById('staffInitials').value) || (staffName ? staffName.split(' ').map(function(n){return n[0]||''}).join('').toUpperCase() : '');
  var notes = (remark && remark.value) || '';
  var isPaid = markPaid && markPaid.checked;

  var sub=0; (items||[]).forEach(function(it){ sub+= (Number(it.qty||0)*Number(it.price||0)); });
  var rate=(vatEnabled && vatEnabled.checked)? Number(vatRate.value||0):0;
  var vat=sub*(rate/100);
  var estimate=sub+vat;

  var doc = new jspdfNS.jsPDF({unit:'mm', format:'a5', orientation:'portrait'});
  var pageW = doc.internal.pageSize.getWidth();
  var pageH = doc.internal.pageSize.getHeight();
  var margin = 8; var cursorY = margin; var contentW = pageW - margin*2; var lineH=5;

  function ensureSpace(n){ if(cursorY + n > pageH - margin - 18){ doc.addPage(); cursorY = margin; } }
  function wrap(txt){ return doc.splitTextToSize(String(txt||''), contentW); }
  function section(title){ ensureSpace(10); doc.setFont('helvetica','bold'); doc.setFontSize(11); doc.text(String(title), margin, cursorY); cursorY+=2; doc.setDrawColor(180); doc.line(margin,cursorY,pageW-margin,cursorY); cursorY+=3; doc.setFont('helvetica','normal'); doc.setFontSize(10); }
  function labelValue(label, value){ ensureSpace(lineH); doc.setFont('helvetica','bold'); doc.text(String(label), margin, cursorY); doc.setFont('helvetica','normal'); doc.text(String(value||''), margin+30, cursorY); cursorY+=lineH; }

  // Header with logo
  try{ var lp=document.getElementById('logoPreview'); if(lp && lp.naturalWidth){ var c=document.createElement('canvas'); c.width=lp.naturalWidth; c.height=lp.naturalHeight; var ctx=c.getContext('2d'); ctx.drawImage(lp,0,0); var data=c.toDataURL('image/jpeg'); doc.addImage(data,'JPEG', margin, cursorY, 24, 12); doc.setFont('helvetica','bold'); doc.setFontSize(16); doc.text('BTLTech Ltd', margin+28, cursorY+6); doc.setFont('helvetica','normal'); doc.setFontSize(9); doc.text('Professional Device Repair Services', margin+28, cursorY+11); cursorY+=16; } }catch(e){}
  if(cursorY===margin){ doc.setFont('helvetica','bold'); doc.setFontSize(16); doc.text('BTLTech Ltd', margin, cursorY+6); doc.setFont('helvetica','normal'); doc.setFontSize(9); doc.text('Professional Device Repair Services', margin, cursorY+11); cursorY+=16; }
  doc.setFont('helvetica','normal'); doc.setFontSize(9); doc.text(wrap('123 High Street, London W12 3AB • info@btltech.co.uk • 020 8746 0193 • 07445 363599 • www.btltech.co.uk'), margin, cursorY); cursorY+=6; doc.setDrawColor(20); doc.line(margin,cursorY,pageW-margin,cursorY); cursorY+=5; doc.setFont('helvetica','bold'); doc.setFontSize(12); doc.text('DROP-OFF RECEIPT', pageW/2, cursorY, {align:'center'}); if(isPaid){ doc.setTextColor(21,128,61); doc.text('PAID', pageW - margin, cursorY, {align:'right'}); doc.setTextColor(0,0,0); } cursorY+=6;

  section('Receipt Info'); labelValue('Receipt #:', invoiceNum); labelValue('Date:', invoiceDate); labelValue('Staff:', staffName || staffInitials || '');
  section('Customer Info'); labelValue('Name:', customerName); if(customerPhone) labelValue('Phone:', customerPhone); if(customerEmail) labelValue('Email:', customerEmail);
  section('Device Info'); labelValue('Device:', deviceInfo||''); if(devSerial) labelValue('Serial/IMEI:', devSerial); if(devAccessories) labelValue('Accessories:', devAccessories); if(devCondition) labelValue('Condition:', devCondition);
  section('Service Details'); var issue=wrap('Reported issue: '+(reportedFault||'')); doc.text(issue, margin, cursorY); cursorY+=issue.length*(lineH-1); if(notes){ var nl=wrap('Notes: '+notes); doc.text(nl, margin, cursorY); cursorY+=nl.length*(lineH-1); }
  if(items && items.length){ ensureSpace(lineH); doc.setFont('helvetica','bold'); doc.text('Quoted items:', margin, cursorY); cursorY+=lineH; doc.setFont('helvetica','normal'); var maxItems=8; for(var i=0;i<items.length && i<maxItems;i++){ var it=items[i]; var amt=Number(it.qty||0)*Number(it.price||0); ensureSpace(lineH); var line='• '+(it.desc||'Item')+'  x'+(it.qty||1); doc.text(wrap(line), margin, cursorY); doc.text(gbp(amt), pageW - margin, cursorY, {align:'right'}); cursorY+=lineH; } if(items.length>maxItems){ ensureSpace(lineH); doc.setFont('helvetica','italic'); doc.text('+'+(items.length-maxItems)+' more (see full invoice)', margin, cursorY); doc.setFont('helvetica','normal'); cursorY+=lineH; } }
  ensureSpace(lineH); doc.setFont('helvetica','bold'); doc.text('Estimated cost: '+gbp(estimate), margin, cursorY); cursorY+=lineH;
  section('Terms & Conditions'); var terms='• Warranty: 30-day warranty on completed repairs (excludes accidental/liquid damage)\n'+'• Data: Data recovery not guaranteed—please back up your data\n'+'• Uncollected: Devices not collected within 60 days may be sold/recycled to recover costs\n'+'• Liability: Liability limited to the repair cost (no liability for data loss)\n'+'• Payment: Payment due on completion; cash, card, or bank transfer\n'+'• Estimates: Valid 30 days and may change after diagnosis'; var tl=wrap(terms); if(cursorY + tl.length*(lineH-1) > pageH - margin - 24){ doc.addPage(); cursorY=margin; } doc.text(tl, margin, cursorY); cursorY+=tl.length*(lineH-1);
  var signY = pageH - margin - 12; if(cursorY > signY - 10){ doc.addPage(); signY = pageH - margin - 12; cursorY = margin; } doc.setDrawColor(50); doc.line(margin, signY, margin+60, signY); doc.text('Customer Signature', margin, signY+5); var rx=pageW - margin - 60; doc.line(rx, signY, rx+60, signY); doc.text('Staff Signature'+(staffInitials?' ('+staffInitials+')':''), rx, signY+5);
  doc.save('BTLTech-Receipt-'+invoiceNum+'.pdf');
}
</script>
</body>
</html>
